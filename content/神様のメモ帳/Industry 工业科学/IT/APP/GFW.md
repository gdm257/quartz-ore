---
tags:
  - flag/APP/Network/_Theme/GFW
  - Label/Industry-工业科学/IT/APP/Server/Service
---

### TLDR

[SNI 阻断与解决方案 — Steemit](https://steemit.com/cn/@v2ray/sni)

[揭示和规避中国对加密SNI（ESNI）的封锁](https://gfw.report/blog/gfw_esni_blocking/zh/)


| GFW                | 最弱解决方法 | 推荐解决方法       |
| ------------------ | ------------ | ------------------ |
| DNS 污染           | hosts        | DoH/DoT            |
| 封 IP              | -            | ShadowsSocks/V2Ray |
| VPN 流量特征       | -            | ShadowsSocks/V2Ray |
| QoS for UDP        | 商业加速器   | -                  |
| 私有协议流量特征   | -            | TLS                |
| SNI 阻断（封握手） | 换域名       | 走代理             |
| TLS 隐式使用特征   | -            | 机场               |

### 史前时代：最早的封锁大约是 DNS 投毒和 IP 黑名单。

### 攻防战 1.0

网友们很快想到了解决方案，就是使用 hosts 文件指定 IP 地址。后来封锁升级了，不是针对 IP 地址的了，而是针对每一个网络连接。受限于为数不多的几个出入境节点，网民的每一个出境网络连接实际上都被扫描过一遍。于是网络协议最初设计时，并未考虑封锁这回事，无论是 HTTP 还是 HTTPS，只需要扫描每个连接的前几十个字节，就可以得到其目标地址（域名）。HTTP 是通过其 Host 头，而 HTTPS 是通过 SNI。至此，针对域名，没有封不掉的，只有不想封的。那就只能绕路了，也就是代理。代理的主要三种模式是 Socks、HTTP 和 VPN。然后 Shadowsocks 横空出世。由于 Shadowsocks 太过火爆，其作者被公安机关约谈，勒令不得继续参于相关项目的开发。

### 攻防战 2.0

中国那么多人，要把相关人员一一找出来喝茶，也不是一件容易的事。封锁这事，还得从网络连接着手。对于一台国内的机器往一个国外的服务器发送数据的网络连接，有两种检测方式，被动式和主动式。被动式是指检测方只观察连接中传输的内容，当内容符合某种模式（比如关键字）的时候，就把连接中断，或者服务器 IP 列入黑名单。上述的所有封锁方式均为被动式。而主动式指的是，当观察到一个不可识别的连接时，检测方主动发起一个去往服务器的连接，通过一些编造的数据，探测出服务器是不是一台代理服务器，为了应对这一探测方式，Shadowsocks 对其加密方式升级了两次（OTA 和 AEAD）。

### 攻防战 3.0

从信息学的角度来说，Shadowsocks 协议是一个近乎完美的协议。它的数据完全随机，无法 100% 确定这个网络连接是否为 Shadowsocks。但从另一方面来说，网络数据并不是均匀分布的，保守来说，HTTP 和 HTTPS 流量占据了 70% 以上。而如果一个服务器接收的流量 90% 是杂乱无章的，那么它就很可疑了。虽然检测方不能严格证明那就是 Shadowsocks，但秀才遇到兵啊……既然随机数据可疑，那我们就把数据伪装成 HTTP 或者 HTTPS 好了。由于 HTTPS 是大势所趋，并且 HTTPS 传输的内容天生不可能被破解，把代理数据伪装成 HTTPS 也是一个比较合理的选择。检测方无法判断一个 HTTPS 连接是正常的网站流量，还是代理。

### 第二战场 1.0

所有的代理工具都不是系统自带的，用户使用代理工具之前，需要先下载和安装。于是封锁下载途径也是一种封锁。Apple 就按要求移除了所有 VPN 应用。此战场防御方完败。

目前明面上的攻防到此为止，接下来说说一些想法和揣测。

### 攻防战 4.0 未来篇

虽然流量经过了加密，但加密的只是内容，不能排除还有其它的特征。比如 TLS (HTTPS 所用的加密协议）的握手环节，客户端和服务器互相发送的数据是有规律的。比如握手三次，每一次的数据量大致是固定的。如果有一个连接，也有三次握手，每一次的数据量和 TLS 相当，但是内容是混乱的，那么这个连接是不是 Shadowsocks 连接呢？当然 Shadowsocks 有一些额外的数据，这个另说。目前翻墙圈在这一问题上有很大的争论。对于检测方是否足够强的技术做类似的检测，以及是否有足够的把握只封代理都存在疑惑。但毫无疑问，这将是下一个值得研究的领域。

另一个热点是分布式或者P2P。

这一领域已经被 Tor 证明为成功或者失败了（取决于你怎么看待 Tor）。我个人不喜欢 Tor 因为它速度太慢。虽然 P2P 这一术语最近很热，听上去也很有希望，但实际上它并不适用于翻墙。翻墙的过程需要【墙内的P】2【墙外的P】，并不是任意两个 P 都可以自由组合的。

目前对翻墙 P2P 的研究和应用都比较少，前景不明朗，观望中。



### 2022.10 GFWの升级——根据行为特征封锁端口


99% 锁定 nginx ssl 了。
nginx 80 没问题。
443 无法建立 ssl 连接，连响应都没有，显示「远程主机强迫关闭了一个现有的连接」。

防火墙？很有可能。因为 nginx 日志一个字没有。很可能数据包都没被 nginx 接收就被防火墙丢弃了。
查看了半天，iptables 应该是没启用。也就是说 443 连不上与防火墙无关……如果是 GFW 封端口就麻烦了。


GFW 443 端口屏蔽？很有可能。这样就能解释用 v2ray 代理就能连上 nginx ssl  了。




这个月我的网站换了两台服务器，接连访问异常。

一开始我以为是 Docker/Nginx/iptables/upstream/Debian/CentOS 的问题，但两台服务器出现一模一样的症状，我就意识到不对劲。经过仔细排查与测试，最终锁定了问题所在，没错，我曾预想过的 **「最糟糕」** 的封禁方式——

**GFW 根据「行为特征」封锁端口**

我在网上找到了大量的类似案例，我的遭遇再结合诸多帖子与群友的讨论，可以确定，近两个月 GFW 封锁不断增强，目测是完成了一次升级：

- 封端口是**动态封锁**，满足某些条件自动触发
- 同 IP **其他端口不受影响**
- 端口**封锁时间不定**，短的一周，长的到现在都没恢复
- 最主要的触发条件应该是 **「统计学行为特征」** ，即 **长时间、单点、单端口、TLS/SSL、大流量**
- 与使用的客户端、反代、服务端、**协议无关**
- SSL/TLS 流量照样封，包括但不限于 ss/v2ray/trojan 的 SSL/TLS 方案
- **连续数小时、流量超过几十 GB** 即有可能触发

综上，GFW 本次升级并不是依靠传统的「流量特征」，也就是说，GFW 不能「确信」你就是在用梯子，更不可能「破解」加密流量。GFW 是根据「行为特征」来判断的， **你的行为不像是在访问一个正常的网站，GFW 就封掉端口**

学过统计的应该清楚，建立这个模型其实是相当容易的，连机器学习算法都不需要。我当初就预想过这种封禁方案——糟糕的是，除了负载均衡，现有的翻墙方案流量一大就无法瞒过 GFW 的识别。该封禁方案的瓶颈不在技术，而在性能。GFW 出口本身就 7×24 压力山大了，如果要用这种统计学方案，单单日志就需要大量额外硬件，更别提还要实时统计分析日志……可万万没想到这一天来的这么快，目前来看几乎无解，先凑活一阵子再说吧

