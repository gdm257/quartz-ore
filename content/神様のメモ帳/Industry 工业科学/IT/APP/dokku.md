---
tags:
  - Label/Industry-工业科学/IT/APP/Server/Self-hosted
  - flag/Platform/Linux独占
  - flag/APP/Layer/PaaS
---

## Brief

- Alternatives
    - [[coolify]]
    - [[portainer]]
    - [m-adawi/swarm-cd](https://github.com/m-adawi/swarm-cd)

- Ecosystem
    - A plugin is a collection of scripts that will be run based on naming convention
    - Plugin 一般使用 [[Docker]] image，而不是直接在 [[dokku]] 所在环境安装依赖
    - [Plugins - Dokku Documentation](https://dokku.com/docs/community/plugins/)

- Data
    - App config
        - `/var/lib/dokku/`
            - `config/`
                - Properties set and managed by plugins
            - `data/`
                - Files generated or extracted by various plugins
                - `storage/`
                    - `<app>/` 子文件夹推荐与 app 同名
            - `services/`
            - `plugins/`
        - `/home/dokku/`
            - Certain parts of Dokku core store data in this location
    - Networks
        - `dokku network:report`
        - `dokku network:create $NETWORK`
        - [[Docker]] networks generated by Dokku should be recreated
    - Users
        - 如果 [[dokku]] 运行在 [[Docker]] container 中，那么需要手动管理 container 里的 users
        - 因为 [[sshd]] 根据 `/etc/passwd` 来判断 user 是否存在，以及找到公钥
        - 官方 [[Docker]] 镜像自带一些 users，但都没有持久化，适合添加 SSH 公钥的只有 `dokku`。测试发现，`dokku` 能登录但是无法运行命令，打印完 dokku cli 的帮助信息就退出
        - 也就是说，`dokku` 的 SSH 登录只能执行一次 `dokku` 命令，`ssh -t dokku@dokku.me -- <dokku_subcommand> args`
        - The SSH (Git) user is _always_ `dokku`, as this is the system user that the `dokku` binary uses to perform all its actions
        - Admin users (with name containing word `admin`) and root can add keys remotely
        - Users in Dokku are managed via the `~/dokku/.ssh/authorized_keys` file (`/home/dokku/.ssh/authorized_keys` in [[Docker]]), which are managed by `dokku ssh-keys` plugin
        - [Remote Commands - Dokku Documentation](https://dokku.com/docs/deployment/remote-commands/)
    - [Backup and Recovery - Dokku Documentation](https://dokku.com/docs/advanced-usage/backup-recovery/)

- Installation
    - Run [[dokku]] in [[Docker]] or host
    - SSH
        - Deploying app with private Git
            - `su - dokku`
            - `ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts`
            - `ssh -T git@github.com`

- Philosophy
    - GitOps
        - [[Docker]] 使用 Compose file 完成运行命令的模板化，使用 [[docker-compose]] 来部署
        - [[k8s]] 使用 Helm 完成模板化，使用 [[kubectl]] 来部署
        - [[dokku]] 使用 [[git]] repo 完成模板化，使用 `dokku` + `git push` 来部署
        - [[dokku]] 使用 [[git]] repo 完成模板化，使用 webui + `git push` 来部署

- Fundamentals
    - Database
        - 安装 plugin、通过 plugin 创建 database、再将其 link 到 application
        - [[dokku]] 通过 [[Docker]] socket 拉取 database 镜像并运行 database 容器，数据一般存储在 `/var/lib/dokku/services/<plugin-name>/<db-name>/data/`。数据库认证密码随机生成，所谓 link，一般是给 application 设置一个 `DATABASE_URL` 环境变量（如 [[PostgreSQL|postgres]] plugin）

- Pro
    - Easy to deploy
        - 算是开源 PaaS 里最容易搭建的
        - 可跑在 host/[[Docker]]/[[k8s]]，不挑环境
    - Reverse proxy
        - 部署 app 不指定域名，默认当成 PaaS 域名 `<app>.your.dokku.hostname.tld`
        - [Deploying an Application - Dokku Documentation](https://dokku.com/docs/deployment/application-deployment/#deploying-to-subdomains)

- Con
    - NOT Support cluster
        - [[dokku]] 本身只能单节点，没有高可用
        - Stateful data 全在一台机器上，无法扩展
    - NOT Support [[Docker Swarm]]
        - postgres plugin 创建的 db service 使用的是 [[Docker]] 默认的 `bridge` 网络
        - 目测 application 也是这样
        - 也就是说，根本无法使用 overlay 网络以及自定义网络！
    - NOT Support DNS record management
        - 仍需要手动管理 DNS records，这点跟 [[docker-compose]] 没区别

## Ecosystem

- Examples
    - `dokku apps:create <app>`
    - Create [[Heroku]] style [[git]] repo
    - Deploy
        - Clone repo in any machine
        - `cd repo`
        - `git remote add dokku ssh://dokku@<your.dokku.com>:<port>/<app>`
            - 私钥呢？
        - `git push dokku main`
